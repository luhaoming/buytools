<!DOCTYPE html>
<html>
<head>
  <title>MOMO紅包排程產生器</title>
  <style>
    body { font-family: sans-serif; display: flex; justify-content: center; margin: 0; background-color: #f0f0f0; }
    .container { width: 90%; max-width: 600px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background-color: white; }
    textarea { width: 100%; height: 150px; box-sizing: border-box; margin-bottom: 10px; }
    pre[id^="output"] {
      cursor: pointer;
      background-color: #f4f4f4;
      border: 1px solid #ccc;
      padding: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 1.2em;
    }
    .copy-message { color: green; margin-top: 5px; height: 20px; }
    button { padding: 8px 16px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; }
    .btn-generate { background-color: #007bff; color: white; border: none; }
    .btn-clear { background-color: #6c757d; color: white; border: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>MOMO紅包排程產生器</h1>
    <textarea id="input" placeholder="貼上活動資訊...">Momo好運抽抽樂~10/16
10:00、13:00、17:00、21:00
1小時可各抽第2次
https://momo.dm/6qe66U</textarea>
    <br>
    <button class="btn-generate" onclick="generateCron()">產生排程</button>
    <button class="btn-clear" onclick="clearInput()">清理</button>
    
    <div id="copy-status" class="copy-message"></div>

    <h2>產生結果 (提早一分鐘)</h2>
    <pre id="output"></pre>
    
    <h2>產生結果 (精準時間)</h2>
    <pre id="output-exact"></pre>
  </div>

  <script>
    // 清理按鈕邏輯
    function clearInput() {
      const input = document.getElementById('input');
      input.value = '';
      generateCron(); // 同步清空輸出
      input.focus();
    }

    function simplifyHours(hours) {
      if (hours.length === 0) return '';
      const uniqueHours = [...new Set(hours)].sort((a, b) => a - b);
      const simplified = [];
      let start = uniqueHours[0];
      for (let i = 1; i <= uniqueHours.length; i++) {
        if (i === uniqueHours.length || uniqueHours[i] !== uniqueHours[i-1] + 1) {
          const end = uniqueHours[i-1];
          simplified.push(start === end ? `${start}` : `${start}-${end}`);
          if (i < uniqueHours.length) start = uniqueHours[i];
        }
      }
      return simplified.join(',');
    }

    function generateCron() {
      const content = document.getElementById('input').value.trim();
      const out1 = document.getElementById('output');
      const out2 = document.getElementById('output-exact');

      // 若內容為空，直接清空輸出並返回
      if (!content) {
        out1.textContent = '';
        out2.textContent = '';
        return;
      }
      
      const lines = content.split('\n');
      const commentLine = lines.find(line => line.trim().length > 0);
      const comment = commentLine ? `#${commentLine.trim()}` : '';

      const regex = /\d{2}:\d{2}/g;
      const times = content.match(regex) || [];

      if (times.length === 0) {
        out1.textContent = '找不到時間資訊。';
        out2.textContent = '找不到時間資訊。';
        return;
      }
      
      const firstTime = times[0];
      const [firstHour, firstMinute] = firstTime.split(':').map(Number);
      
      const hoursEarly = [];
      const hoursExact = [];

      times.forEach(time => {
        const [hour, minute] = time.split(':').map(Number);
        hoursExact.push(hour);
        const earlyHour = (minute === 0) ? (hour - 1 + 24) % 24 : hour;
        hoursEarly.push(earlyHour);
      });
      
      const allHoursEarly = simplifyHours(hoursEarly);
      const allHoursExact = simplifyHours(hoursExact);

      // 提早一分鐘
      const cronMinuteEarly = (firstMinute - 1 + 60) % 60;
      const outputLinesEarly = [
        `${comment}`,
        `${cronMinuteEarly} ${allHoursEarly} * * * ( sleep 50 && ~/tasks/gchkin.sh redbag)`,
        `${cronMinuteEarly} ${allHoursEarly} * * * ( sleep 55 && ~/tasks/gchkin.sh redbag)`
      ];
      out1.textContent = outputLinesEarly.filter(Boolean).join('\n');

      // 精準時間
      const outputLinesExact = [
        `${comment}`,
        `${firstMinute} ${allHoursExact} * * * ~/tasks/gchkin.sh redbag`
      ];
      out2.textContent = outputLinesExact.filter(Boolean).join('\n');
    }

    function copyOutput(elementId) {
      const text = document.getElementById(elementId).textContent;
      if (!text || text.includes('找不到')) return;
      navigator.clipboard.writeText(text).then(() => {
        const status = document.getElementById('copy-status');
        status.textContent = '已複製!';
        setTimeout(() => { status.textContent = ''; }, 2000);
      });
    }

    const textarea = document.getElementById('input');
    textarea.addEventListener('input', generateCron);
    textarea.addEventListener('paste', generateCron);
    document.getElementById('output').addEventListener('click', () => copyOutput('output'));
    document.getElementById('output-exact').addEventListener('click', () => copyOutput('output-exact'));
    document.addEventListener('DOMContentLoaded', generateCron);
  </script>
</body>
</html>