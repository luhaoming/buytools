<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§Ÿè³ƒé€€ç§Ÿçµç®—ç¢ºèªæ›¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <style>
        @media print {
            @page { size: A4; margin: 10mm; } /* å¼·åˆ¶ A4 é‚Šç•Œ */
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .shadow-lg { box-shadow: none; border: 1px solid #000; }
            .print-bg-force { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            input::placeholder { color: transparent; }
            
            /* åˆ—å°æ™‚å¼·åˆ¶å­—é«”å¾®èª¿ */
            .text-xl { font-size: 1.1rem; }
            .text-4xl { font-size: 2rem; }
            .h-32 { height: 6rem; } /* ç°½åæ¬„é«˜åº¦ç¸®æ¸› */
        }
        
        .stamp-box {
            border: 3px solid #b91c1c;
            border-radius: 4px;
            color: #b91c1c;
            transform: rotate(-3deg);
            opacity: 0.9;
            mask-image: radial-gradient(#000, rgba(0,0,0,.85));
        }
        input:disabled {
            background-color: transparent;
            color: #374151;
            border-bottom: 1px dashed #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-2 md:p-6 font-sans text-gray-800">

<div id="app" class="max-w-2xl mx-auto bg-white shadow-lg rounded-xl overflow-hidden print-bg-force relative print:p-4 print:text-sm">
    
    <div v-if="isReadOnly" class="absolute top-20 right-4 border-2 border-slate-200 text-slate-300 px-4 py-2 text-4xl font-black rounded-lg transform rotate-12 pointer-events-none no-print z-0 opacity-50">
        READ ONLY
    </div>

    <div class="bg-slate-900 p-4 text-white flex justify-between items-center no-print z-10 relative">
        <div class="flex items-center gap-2">
            <h1 class="font-bold text-lg tracking-wide">
                {{ isReadOnly ? 'é€€ç§Ÿçµç®— (æˆ¿å®¢ç‰ˆ)' : 'ç§Ÿè³ƒé€€ç§Ÿçµç®—ç¢ºèªæ›¸' }}
            </h1>
        </div>
        <button v-if="!isReadOnly" @click="copyLink" 
            class="text-xs px-3 py-2 rounded transition border border-slate-700 flex items-center gap-2 font-medium"
            :class="linkCopied ? 'bg-emerald-600 text-white border-emerald-500' : 'bg-slate-800 hover:bg-slate-700 text-gray-200'">
            <span v-if="linkCopied">âœ“ é€£çµå·²è¤‡è£½</span>
            <span v-else>ğŸ”— ç”¢ç”Ÿå‚³é€é€£çµ (å”¯è®€)</span>
        </button>
        <div v-else class="text-xs bg-slate-800 px-3 py-1 rounded text-gray-400">
            è«‹ç¢ºèªä¸‹æ–¹é‡‘é¡ä¸¦ç°½å
        </div>
    </div>

    <div class="p-6 md:p-8 space-y-6 print:space-y-3 print:p-0 relative z-0">
        
        <div class="text-center border-b-2 border-gray-800 pb-2 mb-4 print:mb-2">
            <h2 class="text-2xl font-black text-gray-900 tracking-widest print:text-xl">é€€ç§Ÿçµç®—ç¢ºèªæ›¸</h2>
            <p class="text-sm text-gray-500 mt-1 print:text-xs">ç§Ÿè³ƒå¥‘ç´„çµ‚æ­¢èˆ‡è²»ç”¨çµæ¸…æ˜ç´°</p>
        </div>

        <div class="grid grid-cols-2 gap-8 print:gap-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">æ‰¿ç§Ÿäºº (ä½æˆ¶)</label>
                <input v-model="form.name" :disabled="isReadOnly" type="text" class="w-full border-b border-gray-300 focus:border-gray-800 outline-none py-1 text-xl font-bold bg-transparent placeholder-gray-300 print:text-lg">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">çµç®—æ—¥æœŸ</label>
                <input v-model="form.date" :disabled="isReadOnly" type="date" class="w-full border-b border-gray-300 focus:border-gray-800 outline-none py-1 text-lg bg-transparent font-mono print:text-base">
            </div>
        </div>

        <div>
            <h3 class="font-bold text-gray-800 flex items-center gap-2 mb-2 text-sm uppercase tracking-wide">
                <span class="w-1.5 h-1.5 bg-gray-800 rounded-full"></span>
                æ‡‰é€€é‚„æ¬¾é … (æŠ¼é‡‘)
            </h3>
            <div class="bg-gray-50 print:bg-transparent rounded border border-gray-200 p-3 print:p-1 space-y-2">
                <div class="flex gap-3 items-center" v-for="(item, idx) in form.refunds" :key="'ref'+idx">
                    <input v-model="item.name" :disabled="isReadOnly" class="flex-1 bg-transparent border-b border-gray-200 focus:border-gray-500 outline-none py-1 text-sm" placeholder="é …ç›®åç¨±">
                    <div class="relative w-28">
                        <span class="absolute left-0 top-1 text-gray-400 text-sm">$</span>
                        <input v-model.number="item.amount" :disabled="isReadOnly" type="number" class="w-full pl-4 bg-transparent border-b border-gray-200 focus:border-gray-500 outline-none py-1 text-right font-mono text-gray-800" placeholder="0">
                    </div>
                    <button v-if="!isReadOnly" @click="removeRow('refunds', idx)" class="text-gray-300 hover:text-red-500 no-print px-1">Ã—</button>
                </div>
                <button v-if="!isReadOnly" @click="addRow('refunds')" class="text-xs text-emerald-700 font-bold hover:underline no-print mt-1">+ æ–°å¢é …ç›®</button>
            </div>
        </div>

        <div>
            <h3 class="font-bold text-gray-800 flex items-center gap-2 mb-2 text-sm uppercase tracking-wide">
                <span class="w-1.5 h-1.5 bg-gray-800 rounded-full"></span>
                é›»è²»çµç®—
            </h3>
            <div class="border border-gray-200 rounded p-3 print:p-2">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-bold text-gray-500 bg-gray-100 print:bg-transparent px-2 py-1 rounded">è¨ˆè²»æ¨™æº–: ${{ elec.rate }} / åº¦</span>
                </div>
                <div class="flex items-end gap-4 text-sm">
                    <div class="flex-1">
                        <span class="block text-[10px] text-gray-400 mb-1">æœŸæœ«è®€æ•¸</span>
                        <input v-model.number="elec.end" :disabled="isReadOnly" type="number" class="w-full border-b border-gray-300 py-1 font-mono font-bold text-lg print:text-base">
                    </div>
                    <div class="pb-2 text-gray-400">-</div>
                    <div class="flex-1">
                        <span class="block text-[10px] text-gray-400 mb-1">æœŸåˆè®€æ•¸</span>
                        <input v-model.number="elec.start" :disabled="isReadOnly" type="number" class="w-full border-b border-gray-300 py-1 font-mono text-gray-500 print:text-base">
                    </div>
                    <div class="pb-2 text-gray-400">=</div>
                    <div class="text-right">
                        <span class="block text-[10px] text-gray-400 mb-1">æ‡‰æ‰£é‡‘é¡</span>
                        <div class="font-bold text-red-700 font-mono text-lg print:text-base">-${{ elecTotal }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <h3 class="font-bold text-gray-800 flex items-center gap-2 mb-2 text-sm uppercase tracking-wide">
                <span class="w-1.5 h-1.5 bg-gray-800 rounded-full"></span>
                å…¶ä»–ä»£æ‰£è²»ç”¨
            </h3>
            <div class="pl-2 space-y-2">
                <div class="flex gap-3 items-center" v-for="(item, idx) in form.charges" :key="'chg'+idx">
                    <input v-model="item.name" :disabled="isReadOnly" class="flex-1 border-b border-gray-200 focus:border-red-500 outline-none py-1 text-sm" placeholder="è²»ç”¨èªªæ˜">
                    <div class="relative w-28">
                        <span class="absolute left-0 top-1 text-gray-400 text-xs">-</span>
                        <span class="absolute left-2 top-1 text-gray-400 text-sm">$</span>
                        <input v-model.number="item.amount" :disabled="isReadOnly" type="number" class="w-full pl-5 border-b border-gray-200 focus:border-red-500 outline-none py-1 text-right font-mono text-red-700" placeholder="0">
                    </div>
                    <button v-if="!isReadOnly" @click="removeRow('charges', idx)" class="text-gray-300 hover:text-red-500 no-print px-1">Ã—</button>
                </div>
                <button v-if="!isReadOnly" @click="addRow('charges')" class="text-xs text-red-700 font-bold hover:underline no-print ml-1">+ æ–°å¢æ‰£æ¬¾</button>
            </div>
        </div>

        <div class="border-t-2 border-gray-800 pt-4 mt-4 print:pt-2 print:mt-2">
            <div class="flex justify-between items-end">
                <div class="text-sm font-bold text-gray-600">æ‡‰é€€é‚„é‡‘é¡ç¸½è¨ˆ</div>
                <div class="text-4xl font-black tracking-tighter" :class="finalTotal >= 0 ? 'text-gray-900' : 'text-red-600'">
                    <span class="text-2xl align-top mr-1">$</span>{{ finalTotal }}
                </div>
            </div>
            <div class="text-right text-[10px] text-gray-400 mt-1">* è‹¥ç‚ºè² æ•¸ï¼Œå‰‡æ‰¿ç§Ÿäººéœ€è£œç¹³å·®é¡</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 print:gap-4 mt-6 break-inside-avoid page-break-inside-avoid">
            
            <div>
                <div class="flex justify-between items-end mb-1 border-b border-gray-200 pb-1">
                    <p class="text-xs font-bold text-gray-500">å‡ºç§Ÿäºº (ç®¡ç†æ–¹) ç°½ç« </p>
                    <label v-if="!isReadOnly" class="text-[10px] text-slate-600 flex items-center gap-1 cursor-pointer hover:text-slate-900 no-print select-none">
                        <input type="checkbox" v-model="useDefaultSig"> é›»å­å°é‘‘
                    </label>
                </div>
                <div class="relative h-32 print:h-24 flex flex-col justify-center items-center">
                    <div v-if="useDefaultSig" class="stamp-box p-3 border-4 text-center select-none print-bg-force">
                        <div class="text-lg font-black leading-none tracking-widest" style="font-family: 'æ ‡æ¥·ä½“', 'KaiTi', serif;">é™¸æµ©éŠ˜å°</div>
                    </div>
                    <canvas v-show="!useDefaultSig" id="sig-agent" class="w-full h-full touch-none absolute top-0 left-0 border border-dashed border-gray-300 bg-gray-50 rounded"></canvas>
                    <button v-if="!isReadOnly && !useDefaultSig" @click="clearPad('agent')" class="absolute bottom-1 right-2 text-[10px] text-gray-400 underline no-print z-10">æ¸…é™¤</button>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-end mb-1 border-b border-gray-200 pb-1">
                    <p class="text-xs font-bold text-gray-500">æ‰¿ç§Ÿäºº ç¢ºèªç°½ç« </p>
                </div>
                <div class="relative h-32 print:h-24">
                    <canvas id="sig-tenant" class="w-full h-full touch-none border border-dashed border-gray-300 bg-white rounded"></canvas>
                    <button @click="clearPad('tenant')" class="absolute bottom-1 right-2 text-[10px] text-gray-400 underline no-print">é‡ç°½</button>
                    <div v-if="isTenantPadEmpty" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-200 text-sm">
                        (ç°½åè™•)
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6 no-print border-t pt-4">
            <button @click="printPdf" class="w-full bg-slate-900 text-white font-bold py-4 rounded hover:bg-black transition flex justify-center items-center gap-2">
                <span>ğŸ–¨ï¸ ç¢ºèªç°½ç½²ä¸¦åˆ—å° / å­˜æª” PDF</span>
            </button>
        </div>

    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick } = Vue;

createApp({
    setup() {
        const linkCopied = ref(false);
        const useDefaultSig = ref(true); 
        const isTenantPadEmpty = ref(true);
        const isReadOnly = ref(false);

        const form = ref({
            name: '',
            date: new Date().toISOString().split('T')[0],
            refunds: [
                { name: 'æˆ¿ç§ŸæŠ¼é‡‘', amount: 15600 },
                { name: 'é‘°åŒ™æŠ¼é‡‘', amount: 100 }
            ],
            charges: [
                { name: 'å‰æœŸæ°´è²»', amount: 200 },
                { name: 'æœªå‡ºå¸³æ°´è²»', amount: 200 }
            ]
        });

        const elec = ref({
            start: 25580,
            end: 25659,
            rate: 5
        });

        let pads = {};

        const elecUsage = computed(() => Math.max(0, elec.value.end - elec.value.start));
        const elecTotal = computed(() => Math.round(elecUsage.value * elec.value.rate));
        
        const finalTotal = computed(() => {
            const r = form.value.refunds.reduce((sum, i) => sum + (Number(i.amount) || 0), 0);
            const c = form.value.charges.reduce((sum, i) => sum + (Number(i.amount) || 0), 0);
            return r - c - elecTotal.value;
        });

        const addRow = (type) => form.value[type].push({ name: '', amount: '' });
        const removeRow = (type, idx) => form.value[type].splice(idx, 1);

        const generateStateString = () => {
            const data = { f: form.value, e: elec.value };
            return LZString.compressToEncodedURIComponent(JSON.stringify(data));
        };

        const copyLink = () => {
            const hash = generateStateString();
            const url = `${window.location.origin}${window.location.pathname}?mode=guest#${hash}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    linkCopied.value = true;
                    setTimeout(() => linkCopied.value = false, 2000);
                });
            } else prompt("è«‹è¤‡è£½ç¶²å€ï¼š", url);
        };

        const initPad = (id, key) => {
            const el = document.getElementById(id);
            if (!el) return;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            el.width = el.offsetWidth * ratio;
            el.height = el.offsetHeight * ratio;
            el.getContext("2d").scale(ratio, ratio);
            
            const pad = new SignaturePad(el, { penColor: 'rgb(0, 0, 0)' });
            pads[key] = pad;
            if (key === 'tenant') pad.addEventListener("beginStroke", () => isTenantPadEmpty.value = false);
        };

        const clearPad = (key) => {
            if (pads[key]) {
                pads[key].clear();
                if (key === 'tenant') isTenantPadEmpty.value = true;
            }
        };

        const printPdf = () => window.print();

        onMounted(async () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'guest') {
                isReadOnly.value = true;
            }

            const hash = window.location.hash.slice(1);
            if (hash) {
                try {
                    const json = LZString.decompressFromEncodedURIComponent(hash);
                    const data = JSON.parse(json);
                    if (data) { form.value = data.f; elec.value = data.e; }
                } catch (e) {}
            }
            await nextTick();
            initPad('sig-agent', 'agent');
            initPad('sig-tenant', 'tenant');
        });

        return {
            form, elec, elecUsage, elecTotal, finalTotal,
            addRow, removeRow, useDefaultSig, isTenantPadEmpty, clearPad,
            copyLink, linkCopied, printPdf, isReadOnly
        };
    }
}).mount('#app');
</script>
</body>
</html>