<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momo All-in-One Tool - ver=2026-01-19.008</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 15px; background-color: #f8f9fa; }
        .output { white-space: pre-wrap; word-break: break-all; font-family: monospace; font-size: 12px; cursor: pointer; }
        textarea { font-size: 12px; }
        .card { margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-header { padding: 10px; font-weight: bold; background-color: #fff; font-size: 14px; }
        .tool-title { border-left: 4px solid #0d6efd; padding-left: 10px; margin-bottom: 10px; font-weight: bold; }
        .tool-title.secondary { border-left-color: #6c757d; }
    </style>
</head>
<body>
    <div id="app" class="container-fluid">
        <h4 class="tool-title">Momo Config Generator (主工具)</h4>
        <div class="card mb-4">
            <div class="card-body">
                <textarea class="form-control mb-2" rows="4" v-model="curlInput" placeholder='貼上 curl 指令...'></textarea>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm flex-grow-1" @click="parseCurl" :disabled="!curlInput">Generate Config</button>
                    <button class="btn btn-outline-danger btn-sm" @click="clearCurl">清理</button>
                </div>

                <div v-if="configOutput" class="mt-3">
                    <div class="card mb-2">
                        <div class="card-header">Config (點擊內容複製)</div>
                        <div class="card-body p-0">
                            <div class="output bg-light p-2 border-0" @click="copyToClipboard(configOutput)">{{ configOutput }}</div>
                        </div>
                    </div>
                    <div class="card mb-2" v-if="rawJson">
                        <div class="card-header">JSON Payload (點擊內容複製)</div>
                        <div class="card-body p-0">
                            <div class="output bg-light p-2 border-0" @click="copyToClipboard(rawJson)">{{ rawJson }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <h4 class="tool-title secondary">Momo Cron Generator (第二工具)</h4>
        <div class="card">
            <div class="card-body">
                <textarea class="form-control mb-2" rows="4" v-model="cronInput" placeholder="貼上活動時間資訊..."></textarea>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-secondary btn-sm flex-grow-1" @click="generateCron" :disabled="!cronInput">產生排程</button>
                    <button class="btn btn-outline-danger btn-sm" @click="clearCron">清理</button>
                </div>

                <div v-if="cronEarly || cronExact">
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">提早一分鐘 (搶標用)</label>
                        <div class="output bg-light p-2 border rounded" @click="copyToClipboard(cronEarly)">{{ cronEarly }}</div>
                    </div>
                    <div>
                        <label class="small fw-bold text-muted">精準時間</label>
                        <div class="output bg-light p-2 border rounded" @click="copyToClipboard(cronExact)">{{ cronExact }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="position-fixed bottom-0 start-50 translate-middle-x mb-3" style="z-index: 1050;">
            <div v-if="clipboardMessage" class="badge bg-success p-2">{{ clipboardMessage }}</div>
        </div>
    </div>

    <script>
        const { createApp, ref, watch } = Vue;
        
        createApp({
            setup() {
                const curlInput = ref('');
                const configOutput = ref('');
                const rawJson = ref('');
                const cronInput = ref('');
                const cronEarly = ref('');
                const cronExact = ref('');
                const clipboardMessage = ref('');
                const currentActivityName = ref('');

                const copyToClipboard = async (text) => {
                    if (!text || text.includes('Error') || text.includes('找不到')) return;
                    try {
                        await navigator.clipboard.writeText(text);
                        clipboardMessage.value = '已複製！';
                        setTimeout(() => clipboardMessage.value = '', 2000);
                    } catch (err) {}
                };

                const parseCurl = () => {
                    try {
                        const input = curlInput.value.trim();
                        const urlMatch = input.match(/curl\s+['"]?([^\s'"]+)/);
                        const dataMatch = input.match(/(?:--data(?:-raw)?|-d)\s+['"](.+?)['"](?:\s|$)/s);
                        if (!urlMatch || !dataMatch) throw new Error('解析 curl 失敗');
                        
                        let postData = dataMatch[1].replace(/\\"/g, '"').replace(/\\\\/g, '\\');
                        const jsonData = JSON.parse(postData);
                        rawJson.value = JSON.stringify(jsonData);
                        
                        const comment = currentActivityName.value ? `// ${currentActivityName.value}\n` : '';
                        configOutput.value = `${comment}api='${urlMatch[1]}'\nisenon=1\nisjson=1\nisapp=1\nisnow=1\npsample='${rawJson.value}'`;
                    } catch (error) {
                        configOutput.value = `Error: ${error.message}`;
                        rawJson.value = '';
                    }
                };

                const simplifyHours = (hours) => {
                    if (hours.length === 0) return '';
                    const sorted = [...new Set(hours)].sort((a, b) => a - b);
                    const res = [];
                    let start = sorted[0];
                    for (let i = 1; i <= sorted.length; i++) {
                        if (i === sorted.length || sorted[i] !== sorted[i-1] + 1) {
                            res.push(start === sorted[i-1] ? `${start}` : `${start}-${sorted[i-1]}`);
                            if (i < sorted.length) start = sorted[i];
                        }
                    }
                    return res.join(',');
                };

                const generateCron = () => {
                    const content = cronInput.value.trim();
                    if (!content) {
                        cronEarly.value = cronExact.value = currentActivityName.value = '';
                        return;
                    }
                    const lines = content.split('\n');
                    currentActivityName.value = lines[0].trim();
                    const times = content.match(/\d{2}:\d{2}/g) || [];
                    if (times.length === 0) {
                        cronEarly.value = cronExact.value = '找不到時間資訊';
                        return;
                    }
                    const [_, firstMin] = times[0].split(':').map(Number);
                    const hExact = times.map(t => parseInt(t.split(':')[0]));
                    const hEarly = times.map(t => {
                        const [h, m] = t.split(':').map(Number);
                        return m === 0 ? (h - 1 + 24) % 24 : h;
                    });
                    const mEarly = (firstMin - 1 + 60) % 60;
                    cronEarly.value = `#${currentActivityName.value}\n${mEarly} ${simplifyHours(hEarly)} * * * ( sleep 50 && ~/tasks/gchkin.sh redbag)\n${mEarly} ${simplifyHours(hEarly)} * * * ( sleep 55 && ~/tasks/gchkin.sh redbag)`;
                    cronExact.value = `#${currentActivityName.value}\n${firstMin} ${simplifyHours(hExact)} * * * ~/tasks/gchkin.sh redbag`;
                    if (curlInput.value && !configOutput.value.includes('Error')) parseCurl();
                };

                const clearCurl = () => { curlInput.value = configOutput.value = rawJson.value = ''; };
                const clearCron = () => { cronInput.value = cronEarly.value = cronExact.value = currentActivityName.value = ''; };

                watch(cronInput, generateCron);

                return { curlInput, configOutput, rawJson, parseCurl, clearCurl, cronInput, cronEarly, cronExact, clearCron, clipboardMessage, copyToClipboard };
            }
        }).mount('#app');
    </script>
</body>
</html>